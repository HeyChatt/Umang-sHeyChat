<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>HeyChat 💬</title>

    <style>
      body {
        font-family: Arial;
        background: #f5f5f5;
        text-align: center;
        margin: 30px;
      }

      #messages {
        border: 1px solid #ccc;
        height: 300px;
        width: 90%;
        margin: 0 auto 10px;
        padding: 10px;
        background: white;
        overflow-y: auto;
      }

      input {
        width: 70%;
        padding: 8px;
      }

      button {
        padding: 8px 15px;
        cursor: pointer;
      }

      /* 💬 Chat bubble styles */
      .message {
        max-width: 70%;
        margin: 5px;
        padding: 8px 12px;
        border-radius: 12px;
        display: inline-block;
        text-align: left;
        word-wrap: break-word;
      }

      .sent {
        background: #0078ff;
        color: white;
        float: right;
        clear: both;
      }

      .received {
        background: #e5e5ea;
        color: black;
        float: left;
        clear: both;
      }

      /* 🌙 Dark mode styles */
      body.dark {
        background-color: #0d1117;
        color: #e6edf3;
        transition: all 0.3s ease;
      }

      body.dark .message.sent {
        background-color: #1f6feb;
        color: white;
      }

      body.dark .message.received {
        background-color: #161b22;
        color: #c9d1d9;
      }

      button {
        transition: background 0.3s ease, color 0.3s ease;
      }
      /* ✏️ Edit & 🗑️ Delete Buttons Style */
.message button {
  background-color: #f1f1f1;
  border: none;
  padding: 4px 8px;
  margin: 3px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 13px;
  transition: all 0.2s ease-in-out;
}

.message button:hover {
  background-color: #d9d9d9;
}

.message button:active {
  transform: scale(0.95);
}

.message.sent {
  background-color: #e8f5e9; /* light green for your own messages */
}

.message.received {
  background-color: #fff; /* white for others' messages */
}

.message {
  padding: 8px 10px;
  border-radius: 10px;
  margin: 6px;
  max-width: 80%;
  text-align: left;
  display: inline-block;
  word-wrap: break-word;
  }
    </style>
  </head>

  <body>
    <button id="themeToggle" style="position:absolute;top:10px;right:10px;">🌙</button>

    <!-- 🔐 LOGIN / SIGNUP SECTION -->
    <div id="authSection">
      <h2>Welcome to HeyChat 👋</h2>
      <input id="email" type="email" placeholder="Email"><br><br>
      <input id="password" type="password" placeholder="Password"><br><br>
      <button onclick="login()">Login</button>
      <button onclick="signup()">Sign Up</button>
    </div>

    <!-- 💬 CHAT SECTION (hidden until login) -->
    <div id="chatSection" style="display:none;">
      <h2>HeyChat 💬</h2>
      <p id="userInfo" style="font-size:14px; color:#555;"></p>
      <div id="messages"></div>
      <form id="chat-form">
        <input type="text" id="text" placeholder="Type a message..." autocomplete="off" />
        <button type="submit">Send</button>
      </form>
      <button onclick="logout()" style="margin-top:10px; background:red; color:white;">Logout</button>
    </div>

    <!-- ✅ Firebase v11 Modular -->
    <script type="module">
      import {
        initializeApp
      } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";

      import {
        getAuth,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        onAuthStateChanged,
        signOut
      } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

      import {
        getFirestore,
        collection,
        addDoc,
        query,
        orderBy,
        onSnapshot,
        serverTimestamp
      } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

      // ✅ Firebase Config
      const firebaseConfig = {
        apiKey: "AIzaSyAlVJcbUTlxZDd5oMUwvemk-FMiFneid80",
        authDomain: "heychat-1aea9.firebaseapp.com",
        projectId: "heychat-1aea9",
        storageBucket: "heychat-1aea9.appspot.com",
        messagingSenderId: "324327775275",
        appId: "1:324327775275:web:28ecebf9147b87d1655e6e"
      };

      // ✅ Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // --- 🔐 SIGNUP FUNCTION ---
      async function signup() {
        const email = document.getElementById("email").value.trim();
        const password = document.getElementById("password").value.trim();
        if (!email || !password) return alert("Please enter email and password.");
        try {
          await createUserWithEmailAndPassword(auth, email, password);
          alert("✅ Signup successful! You can now log in.");
          setUsername(); // 👈 ask username after signup
        } catch (error) {
          alert("❌ Error: " + error.message);
        }
      }

      // --- 🔐 LOGIN FUNCTION ---
      async function login() {
        const email = document.getElementById("email").value.trim();
        const password = document.getElementById("password").value.trim();
        try {
          await signInWithEmailAndPassword(auth, email, password);
          setUsername(); // 👈 ask username after login
        } catch (error) {
          alert("❌ Error: " + error.message);
        }
      }

      // --- 🚪 LOGOUT FUNCTION ---
      function logout() {
        signOut(auth);
      }

      // ---------- USERNAME SETUP ----------
function setUsername() {
  const user = firebase.auth().currentUser;
  if (!user) return;

  const username = prompt("Enter a username (this will be shown in chat):");
  if (username && username.trim() !== "") {
    db.collection("users").doc(user.uid).set({
      username: username.trim(),
      email: user.email
    });
    alert("Username saved!");
  }
                               }
      // --- 💬 SEND MESSAGE ---
async function sendMessage(e) {
  e.preventDefault(); // prevent page reload
  const textInput = document.getElementById("text");
  const text = textInput.value.trim();

  const user = auth.currentUser;
  if (!user) return alert("Please log in first.");
  if (text === "") return;

  try {
    // Get username from Firestore
    const userDoc = await getDoc(doc(db, "users", user.uid));
    const username = userDoc.exists() ? userDoc.data().username : user.email;

    await addDoc(collection(db, "messages"), {
      text: text,
      name: username,
      uid: user.uid,
      time: serverTimestamp()
    });

    textInput.value = "";
  } catch (error) {
    console.error("Error sending message:", error);
  }
          }

      // --- 👀 LOAD MESSAGES IN REAL TIME ---
      function loadMessages() {
        const q = query(collection(db, "messages"), orderBy("time"));
        const messagesDiv = document.getElementById("messages");

        onSnapshot(q, (snapshot) => {
          messagesDiv.innerHTML = "";
          snapshot.forEach((doc) => {
            const msg = doc.data();
            const div = document.createElement("div");
            div.classList.add("message");

            // ✅ Chat bubble style + Edit/Delete buttons
if (msg.uid === auth.currentUser?.uid) {
  // Message from current user
  div.classList.add("sent");
  div.innerHTML = `
    <b>You:</b> ${msg.text}
    <div style="margin-top:4px;">
      <button onclick="editMessage('${doc.id}', '${msg.text.replace(/'/g, "\\'")}')">✏️ Edit</button>
      <button onclick="deleteMessage('${doc.id}')">🗑️ Delete</button>
    </div>
  `;
} else {
  // Message from others
  div.classList.add("received");
  div.innerHTML = `<b>${msg.name || "Anon"}:</b> ${msg.text}`;
}
messagesDiv.appendChild(div);
          });
          setTimeout(() => {
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
          }, 100);
        });
      }
      // --- ✏️ EDIT MESSAGE ---
async function editMessage(id, oldText) {
  const newText = prompt("Edit your message:", oldText);
  if (newText !== null && newText.trim() !== "") {
    await updateDoc(doc(db, "messages", id), {
      text: newText.trim()
    });
  }
}

// --- 🗑️ DELETE MESSAGE ---
async function deleteMessage(id) {
  if (confirm("Delete this message?")) {
    await deleteDoc(doc(db, "messages", id));
  }
      }

      // --- 🔄 AUTH STATE CHANGE ---
      onAuthStateChanged(auth, (user) => {
        if (user) {
          document.getElementById("authSection").style.display = "none";
          document.getElementById("chatSection").style.display = "block";
          document.getElementById("userInfo").innerText = "Logged in as " + user.email;
          loadMessages();
          document.getElementById("chat-form").addEventListener("submit", sendMessage);
        } else {
          document.getElementById("authSection").style.display = "block";
          document.getElementById("chatSection").style.display = "none";
        }
      });

      // 🧩 Expose functions
      window.signup = signup;
      window.login = login;
      window.logout = logout;
    </script>

    <!-- 🌙 Dark Mode Script -->
    <script>
      const themeToggle = document.getElementById("themeToggle");
      const body = document.body;

      if (localStorage.getItem("theme") === "dark") {
        body.classList.add("dark");
        themeToggle.textContent = "☀️";
      }

      themeToggle.addEventListener("click", () => {
        body.classList.toggle("dark");
        const darkMode = body.classList.contains("dark");
        localStorage.setItem("theme", darkMode ? "dark" : "light");
        themeToggle.textContent = darkMode ? "☀️" : "🌙";
      });
    </script>
  </body>
</html>
