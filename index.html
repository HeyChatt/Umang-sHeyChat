<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>HeyChat üí¨</title>

    <style>
      :root {
        --primary: #0078ff;
        --primary-dark: #005fcc;
        --bg: #f5f7fa;
        --surface: #ffffff;
        --text: #222;
        --sent: #d2eaff;
        --received: #ececec;
        --radius: 12px;
        --transition: all 0.3s ease;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: "Poppins", Arial, sans-serif;
        background: var(--bg);
        color: var(--text);
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
        padding: 20px;
        transition: var(--transition);
      }

      h2 {
        margin-bottom: 15px;
      }

      /* üåô Dark mode */
body.dark {
  background: #0d1117;
  color: #e6edf3;
}

body.dark #messages {
  background: #161b22;
  border-color: #30363d;
}

body.dark input,
body.dark button {
  background: #21262d;
  color: #e6edf3;
  border-color: #30363d;
}

/* ‚úÖ FIXED: Better contrast for message bubbles in dark mode */
body.dark .sent {
  background: #1f6feb; /* rich blue */
  color: #ffffff;
}

body.dark .received {
  background: #2d333b; /* soft dark gray */
  color: #e6edf3;
}

      #themeToggle {
        position: fixed;
        top: 15px;
        right: 15px;
        background: var(--primary);
        color: #fff;
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        font-size: 18px;
        cursor: pointer;
        transition: var(--transition);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      }

      #themeToggle:hover {
        background: var(--primary-dark);
        transform: scale(1.05);
      }

      /* AUTH SECTION */
      #authSection {
        background: var(--surface);
        padding: 25px;
        border-radius: var(--radius);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        text-align: center;
        max-width: 350px;
        width: 100%;
      }

      #authSection input {
        width: 100%;
        padding: 10px;
        margin: 8px 0;
        border: 1px solid #ccc;
        border-radius: var(--radius);
        font-size: 1rem;
      }

      #authSection button {
        width: 48%;
        padding: 10px;
        margin: 5px 1%;
        background: var(--primary);
        border: none;
        color: #fff;
        border-radius: var(--radius);
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
      }

      #authSection button:hover {
        background: var(--primary-dark);
      }

      /* CHAT SECTION */
      #chatSection {
        background: var(--surface);
        border-radius: var(--radius);
        width: 100%;
        max-width: 500px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        padding: 15px;
        display: none;
        flex-direction: column;
        gap: 10px;
      }

      #userInfo {
        font-size: 14px;
        color: gray;
        text-align: left;
      }

      #messages {
        border: 1px solid #ccc;
        height: 400px;
        overflow-y: auto;
        padding: 10px;
        background: var(--surface);
        border-radius: var(--radius);
        scroll-behavior: smooth;
      }

      .message {
        padding: 10px 14px;
        border-radius: var(--radius);
        margin: 6px 0;
        max-width: 75%;
        word-wrap: break-word;
        animation: fadeIn 0.3s ease-in;
      }

      .sent {
        background: var(--sent);
        align-self: flex-end;
        text-align: right;
      }

      .received {
        background: var(--received);
        align-self: flex-start;
        text-align: left;
      }

      .message b {
        display: block;
        font-size: 0.9rem;
        margin-bottom: 3px;
      }

      .message button {
        background: #e8e8e8;
        border: none;
        border-radius: 8px;
        padding: 3px 6px;
        margin: 3px;
        font-size: 12px;
        cursor: pointer;
        transition: var(--transition);
      }

      .message button:hover {
        background: #ccc;
      }

      #chat-form {
        display: flex;
        gap: 10px;
      }

      #chat-form input {
        flex: 1;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: var(--radius);
        font-size: 1rem;
      }

      #chat-form button {
        background: var(--primary);
        border: none;
        color: #fff;
        border-radius: var(--radius);
        padding: 0 16px;
        font-size: 1rem;
        cursor: pointer;
        transition: var(--transition);
      }

      #chat-form button:hover {
        background: var(--primary-dark);
      }

      .logout-btn {
        background: red;
        color: #fff;
        border: none;
        padding: 8px 16px;
        border-radius: var(--radius);
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
      }

      .logout-btn:hover {
        background: #cc0000;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @media (max-width: 600px) {
        body {
          padding: 10px;
        }
        #chatSection {
          padding: 10px;
        }
        #messages {
          height: 350px;
        }
      }
    </style>
  </head>

  <body>
    <button id="themeToggle">üåô</button>

    <!-- üîê AUTH -->
    <div id="authSection">
      <h2>Welcome to HeyChat üëã</h2>
      <input id="email" type="email" placeholder="Email" />
      <input id="password" type="password" placeholder="Password" />
      <div>
        <button id="loginBtn">Login</button>
        <button id="signupBtn">Sign Up</button>
      </div>
    </div>

    <!-- üí¨ CHAT -->
    <div id="chatSection">
      <h2 style="text-align:center;">HeyChat üí¨</h2>
      <p id="userInfo"></p>
      <div id="messages"></div>
      <form id="chat-form">
        <input type="text" id="text" placeholder="Type a message..." autocomplete="off" />
        <button type="submit">Send</button>
      </form>
      <button class="logout-btn" id="logoutBtn">Logout</button>
    </div>

    <!-- ‚úÖ Firebase -->
    <script type="module">
      import {
        initializeApp
      } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
      import {
        getAuth,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        onAuthStateChanged,
        signOut
      } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
      import {
        getFirestore,
        collection,
        addDoc,
        query,
        orderBy,
        onSnapshot,
        doc,
        getDoc,
        setDoc,
        updateDoc,
        deleteDoc,
        serverTimestamp
      } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyAlVJcbUTlxZDd5oMUwvemk-FMiFneid80",
        authDomain: "heychat-1aea9.firebaseapp.com",
        projectId: "heychat-1aea9",
        storageBucket: "heychat-1aea9.appspot.com",
        messagingSenderId: "324327775275",
        appId: "1:324327775275:web:28ecebf9147b87d1655e6e"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      const emailEl = document.getElementById("email");
      const passEl = document.getElementById("password");
      const chatSection = document.getElementById("chatSection");
      const authSection = document.getElementById("authSection");
      const messagesEl = document.getElementById("messages");
      const textEl = document.getElementById("text");
      const chatForm = document.getElementById("chat-form");
      const userInfo = document.getElementById("userInfo");

      async function setUsername(user) {
        const username = prompt("Enter a username for chat:");
        if (username && username.trim() !== "") {
          await setDoc(doc(db, "users", user.uid), {
            username: username.trim(),
            email: user.email
          });
        }
      }

      async function signup() {
        const email = emailEl.value.trim();
        const password = passEl.value.trim();
        if (!email || !password) return alert("Enter email and password.");
        try {
          const cred = await createUserWithEmailAndPassword(auth, email, password);
          await setUsername(cred.user);
          alert("‚úÖ Signup successful!");
        } catch (err) {
          alert("‚ùå " + err.message);
        }
      }

      async function login() {
        const email = emailEl.value.trim();
        const password = passEl.value.trim();
        try {
          await signInWithEmailAndPassword(auth, email, password);
        } catch (err) {
          alert("‚ùå " + err.message);
        }
      }

      function logout() {
        signOut(auth);
      }

      async function sendMessage(e) {
        e.preventDefault();
        const text = textEl.value.trim();
        const user = auth.currentUser;
        if (!user || !text) return;

        try {
          const userDoc = await getDoc(doc(db, "users", user.uid));
          const username = userDoc.exists() ? userDoc.data().username : user.email;
          await addDoc(collection(db, "messages"), {
            text,
            name: username,
            uid: user.uid,
            time: serverTimestamp()
          });
          textEl.value = "";
        } catch (err) {
          console.error(err);
        }
      }

      function loadMessages() {
        const q = query(collection(db, "messages"), orderBy("time"));
<script type="module">
  import {
    initializeApp
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import {
    getAuth,
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    onAuthStateChanged,
    signOut
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import {
    getFirestore,
    collection,
    addDoc,
    query,
    orderBy,
    onSnapshot,
    doc,
    getDoc,
    setDoc,
    updateDoc,
    deleteDoc,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAlVJcbUTlxZDd5oMUwvemk-FMiFneid80",
    authDomain: "heychat-1aea9.firebaseapp.com",
    projectId: "heychat-1aea9",
    storageBucket: "heychat-1aea9.appspot.com",
    messagingSenderId: "324327775275",
    appId: "1:324327775275:web:28ecebf9147b87d1655e6e"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // DOM
  const emailEl = document.getElementById("email");
  const passEl = document.getElementById("password");
  const chatSection = document.getElementById("chatSection");
  const authSection = document.getElementById("authSection");
  const messagesEl = document.getElementById("messages");
  const textEl = document.getElementById("text");
  const chatForm = document.getElementById("chat-form");
  const userInfo = document.getElementById("userInfo");

  let currentChatType = "global"; // "global" or "private"
  let currentChatId = null;

  async function setUsername(user) {
    const username = prompt("Enter a username for chat:");
    if (username && username.trim() !== "") {
      await setDoc(doc(db, "users", user.uid), {
        username: username.trim(),
        email: user.email
      });
    }
  }

  async function signup() {
    const email = emailEl.value.trim();
    const password = passEl.value.trim();
    if (!email || !password) return alert("Enter email and password.");
    try {
      const cred = await createUserWithEmailAndPassword(auth, email, password);
      await setUsername(cred.user);
      alert("‚úÖ Signup successful!");
    } catch (err) {
      alert("‚ùå " + err.message);
    }
  }

  async function login() {
    const email = emailEl.value.trim();
    const password = passEl.value.trim();
    try {
      await signInWithEmailAndPassword(auth, email, password);
    } catch (err) {
      alert("‚ùå " + err.message);
    }
  }

  function logout() {
    signOut(auth);
  }

  async function sendMessage(e) {
    e.preventDefault();
    const text = textEl.value.trim();
    const user = auth.currentUser;
    if (!user || !text) return;

    const userDoc = await getDoc(doc(db, "users", user.uid));
    const username = userDoc.exists() ? userDoc.data().username : user.email;

    if (currentChatType === "global") {
      await addDoc(collection(db, "messages"), {
        text,
        name: username,
        uid: user.uid,
        time: serverTimestamp()
      });
    } else if (currentChatType === "private" && currentChatId) {
      await addDoc(collection(db, "privateChats", currentChatId, "messages"), {
        text,
        name: username,
        uid: user.uid,
        time: serverTimestamp()
      });
    }
    textEl.value = "";
  }

  // --- Load Global Chat
  function loadGlobalChat() {
    currentChatType = "global";
    currentChatId = null;
    messagesEl.innerHTML = "<h4>üåç Global Chat</h4>";
    const q = query(collection(db, "messages"), orderBy("time"));
    onSnapshot(q, (snapshot) => {
      messagesEl.innerHTML = "<h4>üåç Global Chat</h4>";
      snapshot.forEach((docSnap) => renderMessage(docSnap.data(), docSnap.id, "global"));
      messagesEl.scrollTop = messagesEl.scrollHeight;
    });
  }

  // --- Load Private Chat
  function openPrivateChat(otherUid, otherName) {
    const user = auth.currentUser;
    const chatId = [user.uid, otherUid].sort().join("_");
    currentChatType = "private";
    currentChatId = chatId;
    messagesEl.innerHTML = `<h4>üîí Chat with ${otherName}</h4>`;

    const q = query(collection(db, "privateChats", chatId, "messages"), orderBy("time"));
    onSnapshot(q, (snapshot) => {
      messagesEl.innerHTML = `<h4>üîí Chat with ${otherName}</h4>`;
      snapshot.forEach((docSnap) => renderMessage(docSnap.data(), docSnap.id, "private"));
      messagesEl.scrollTop = messagesEl.scrollHeight;
    });
  }

  // --- Render Message Helper
  function renderMessage(msg, id, type) {
    const div = document.createElement("div");
    div.classList.add("message");
    if (msg.uid === auth.currentUser?.uid) {
      div.classList.add("sent");
      div.innerHTML = `<b>You</b>${msg.text}
        <div>
          <button onclick="editMessage('${id}', '${msg.text.replace(/'/g, "\\'")}', '${type}')">‚úèÔ∏è</button>
          <button onclick="deleteMessage('${id}', '${type}')">üóëÔ∏è</button>
        </div>`;
    } else {
      div.classList.add("received");
      div.innerHTML = `<b>${msg.name || "Anon"}</b>${msg.text}`;
    }
    messagesEl.appendChild(div);
  }

  // --- Edit/Delete
  async function editMessage(id, oldText, type) {
    const newText = prompt("Edit your message:", oldText);
    if (!newText || newText.trim() === "") return;
    const path =
      type === "global"
        ? doc(db, "messages", id)
        : doc(db, "privateChats", currentChatId, "messages", id);
    await updateDoc(path, { text: newText.trim() });
  }

  async function deleteMessage(id, type) {
    if (!confirm("Delete this message?")) return;
    const path =
      type === "global"
        ? doc(db, "messages", id)
        : doc(db, "privateChats", currentChatId, "messages", id);
    await deleteDoc(path);
  }

  // --- Show Users
  function loadUsersList() {
    const usersBox = document.createElement("div");
    usersBox.id = "usersBox";
    usersBox.style = "border-top:1px solid #ccc;padding-top:8px;margin-top:8px;";
    usersBox.innerHTML = "<h4>üë• Users</h4>";
    messagesEl.after(usersBox);

    const q = query(collection(db, "users"));
    onSnapshot(q, (snapshot) => {
      usersBox.innerHTML = "<h4>üë• Users</h4>";
      snapshot.forEach((u) => {
        if (u.id === auth.currentUser.uid) return;
        const data = u.data();
        const btn = document.createElement("button");
        btn.textContent = data.username || data.email;
        btn.style =
          "margin:4px;padding:6px 10px;border-radius:8px;border:none;background:#e8e8e8;cursor:pointer;";
        btn.onclick = () => openPrivateChat(u.id, data.username || data.email);
        usersBox.appendChild(btn);
      });
    });
  }

  // --- Auth State
  onAuthStateChanged(auth, (user) => {
    if (user) {
      authSection.style.display = "none";
      chatSection.style.display = "flex";
      userInfo.textContent = `Logged in as ${user.email}`;
      loadGlobalChat();
      loadUsersList();
    } else {
      authSection.style.display = "block";
      chatSection.style.display = "none";
    }
  });

  // --- Events
  document.getElementById("signupBtn").addEventListener("click", signup);
  document.getElementById("loginBtn").addEventListener("click", login);
  document.getElementById("logoutBtn").addEventListener("click", logout);
  chatForm.addEventListener("submit", sendMessage);

  // Expose
  window.editMessage = editMessage;
  window.deleteMessage = deleteMessage;
</script>

    <!-- üåô DARK MODE -->
    <script>
      const themeToggle = document.getElementById("themeToggle");
      const body = document.body;
      if (localStorage.getItem("theme") === "dark") {
        body.classList.add("dark");
        themeToggle.textContent = "‚òÄÔ∏è";
      }
      themeToggle.addEventListener("click", () => {
        body.classList.toggle("dark");
        const isDark = body.classList.contains("dark");
        localStorage.setItem("theme", isDark ? "dark" : "light");
        themeToggle.textContent = isDark ? "‚òÄÔ∏è" : "üåô";
      });
    </script>
  </body>
</html>
